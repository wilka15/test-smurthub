<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartHub AI ‚Äî Full</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --accent:#7a5bff; --accent2:#00a6ff; --bg:#050316; --panel: rgba(255,255,255,0.03); --text:#eaf6ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(135deg,#070014,#001233);font-family:"Orbitron",system-ui,Arial;color:var(--text);-webkit-font-smoothing:antialiased;}

/* layout */
.app{width:94%;max-width:1200px;margin:20px auto;height:88vh;display:flex;gap:18px;align-items:stretch}
.panel{flex:1;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:16px;border:1px solid rgba(122,91,255,0.08);display:flex;flex-direction:column;min-height:0}
#chat{flex:1;overflow:auto;padding:12px 10px}

/* messages */
.msg{display:flex;margin:10px 6px;opacity:1}
.msg.user{justify-content:flex-end}
.bubble{max-width:72%;padding:12px 14px;border-radius:12px;background:rgba(255,255,255,0.03);word-wrap:break-word;white-space:pre-wrap;box-shadow:0 6px 18px rgba(0,0,0,0.45)}
.bubble.user{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001}
.bubble.ai{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--text)}
.msg.user .bubble{animation: slideInRight .32s cubic-bezier(.22,.9,.24,1)}
.msg.ai .bubble{animation: slideInLeft .32s cubic-bezier(.22,.9,.24,1)}
@keyframes slideInRight{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideInLeft{from{transform:translateX(-40px);opacity:0}to{transform:translateX(0);opacity:1}}

/* input row */
.input-row{display:flex;gap:10px;margin-top:12px;align-items:center}
.input-row input[type="text"]{flex:1;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:var(--text);outline:none}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
.btn.clear{background:rgba(255,255,255,0.04);color:var(--text)}

/* slide menu */
.menu-toggle{position:fixed;right:20px;top:20px;z-index:60;padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
.slide-menu{position:fixed;right:0;top:0;height:100vh;width:0;overflow:hidden;z-index:70;transition:width .36s;border-left:1px solid rgba(255,255,255,0.03)}
.slide-menu.open{width:380px}
.menu-inner{height:100%;padding:18px;display:flex;flex-direction:column;gap:14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));backdrop-filter:blur(8px)}
.menu-inner h3{margin:0;color:var(--accent)}
.menu-card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
.menu-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0}

/* typing indicator */
.typing-indicator{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.02)}
.typing-indicator .dot{width:8px;height:8px;border-radius:50%;background:#fff;opacity:0.7;animation:bounce 1.2s infinite}
.typing-indicator .dot:nth-child(1){animation-delay:0s}
.typing-indicator .dot:nth-child(2){animation-delay:0.12s}
.typing-indicator .dot:nth-child(3){animation-delay:0.24s}
@keyframes bounce{0%{transform:translateY(0);opacity:0.35}40%{transform:translateY(-6px);opacity:1}80%{transform:translateY(0);opacity:0.35}100%{transform:translateY(0);opacity:0.35}}

/* neon bg */
.neon-bg{position:fixed;inset:0;z-index:-1;pointer-events:none}
.neon{position:absolute;width:520px;height:520px;border-radius:50%;filter:blur(80px);mix-blend-mode:screen}
.n1{left:-120px;top:-120px;background:radial-gradient(circle,#7a5bff,transparent 40%)}
.n2{right:-140px;bottom:-40px;background:radial-gradient(circle,#00a6ff,transparent 40%)}
.n3{left:30%;top:60%;background:radial-gradient(circle,#b0ff7a,transparent 30%)}

/* small responsive */
@media (max-width:880px){.slide-menu.open{width:100vw}}
</style>
</head>
<body>

<div class="neon-bg"><div class="neon n1"></div><div class="neon n2"></div><div class="neon n3"></div></div>

<div class="app">
  <div class="panel">
    <div id="chat" role="log" aria-live="polite"></div>

    <div class="input-row">
      <input id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ" />
      <button id="attachBtn" class="btn ghost" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">üìé</button>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
      <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="clearBtn" class="btn clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <button id="downloadBtn" class="btn ghost">–°–∫–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥</button>
      <div style="margin-left:auto;font-size:12px;opacity:0.9">–í–µ—Ä—Å–∏—è 1.6 ‚Äî SmartHub AI</div>
    </div>
  </div>
</div>

<button id="menuToggle" class="menu-toggle" aria-expanded="false">‚ò∞</button>

<aside id="slideMenu" class="slide-menu" aria-hidden="true">
  <div class="menu-inner" role="dialog" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <button id="menuClose" class="btn ghost" style="background:transparent">‚úï</button>
    </div>

    <div class="menu-card">
      <div style="font-weight:700;margin-bottom:8px">–ì–æ–ª–æ—Å</div>
      <div class="menu-row">
        <div>–û–∑–≤—É—á–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤</div>
        <button id="ttsToggle" class="btn ghost">–û—Ç–∫–ª—é—á–µ–Ω–æ üîà</button>
      </div>
      <div class="menu-row">
        <div>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TTS</div>
        <button id="stopTTS" class="btn ghost">üõë</button>
      </div>
      <div class="menu-row">
        <div>–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</div>
        <button id="micToggle" class="btn ghost">–í–∫–ª üé§</button>
      </div>
    </div>

    <div class="menu-card">
      <div style="font-weight:700;margin-bottom:8px">–§–æ—Ç–æ</div>
      <div class="menu-row">
        <div>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</div>
        <div style="display:flex;gap:8px">
          <button id="photoBtn" class="btn">üì∑ –í—ã–±—Ä–∞—Ç—å</button>
          <button id="samplePhotoBtn" class="btn ghost" title="–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">–¢–µ—Å—Ç–æ–≤—ã–π</button>
        </div>
      </div>
      <div style="margin-top:8px;font-size:12px;opacity:0.85">–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å".</div>
    </div>

    <div class="menu-card">
      <div style="font-weight:700;margin-bottom:8px">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
      <div class="menu-row">
        <div>–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
        <input id="autosave" type="checkbox" checked />
      </div>
      <div class="menu-row">
        <div>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
        <button id="clearStorage" class="btn ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <div style="margin-top:auto;font-size:12px;opacity:0.85">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: LocalStorage ¬∑ API —á–µ—Ä–µ–∑ proxy</div>
  </div>
</aside>

<script>
/* ========== CONFIG ========== */
const API_URL = 'https://openai-proxy-3.onrender.com/v1/responses';
const SAMPLE_LOCAL_PATH = '/mnt/data/Screenshot_7.png'; // —Ç–µ—Å—Ç–æ–≤—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–∑–∞–º–µ–Ω–∏ –ø—Ä–∏ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏)
const STORAGE_KEY = 'smarthub_chat_v1';

/* ========== ELEMENTS ========== */
const chatEl = document.getElementById('chat');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');
const downloadBtn = document.getElementById('downloadBtn');

const menuToggle = document.getElementById('menuToggle');
const slideMenu = document.getElementById('slideMenu');
const menuClose = document.getElementById('menuClose');

const ttsToggle = document.getElementById('ttsToggle');
const stopTTS = document.getElementById('stopTTS');
const micToggle = document.getElementById('micToggle');
const photoBtn = document.getElementById('photoBtn');
const samplePhotoBtn = document.getElementById('samplePhotoBtn');

const autosaveCheckbox = document.getElementById('autosave');
const clearStorageBtn = document.getElementById('clearStorage');

/* ========== STATE ========== */
let pendingImageBase64 = null; // base64 without prefix
let pendingImageDataUrl = null; // data URL for preview
let ttsEnabled = false;
let currentUtterance = null;
let rec = null;
let micActive = false;
let isSending = false;

/* ========== UTILITIES ========== */
function scrollToBottom() { chatEl.scrollTop = chatEl.scrollHeight; }

function saveChatToStorage() {
  if (!autosaveCheckbox.checked) return;
  const rows = [...chatEl.querySelectorAll('.msg')].map(m => ({
    who: m.classList.contains('user') ? 'user' : 'ai',
    text: m.querySelector('.bubble')?.textContent || ''
  }));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
}

function loadChatFromStorage() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const arr = JSON.parse(raw);
    chatEl.innerHTML = '';
    arr.forEach(item => appendMessage(item.text, item.who, false));
    scrollToBottom();
  } catch(e) { console.warn('load error', e); }
}

function clearStorageAndUI() {
  localStorage.removeItem(STORAGE_KEY);
  chatEl.innerHTML = '';
}

/* ========== RENDERERS ========== */
function appendMessage(text, role='ai', save=true) {
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'ai');
  bubble.textContent = text;
  wrap.appendChild(bubble);
  chatEl.appendChild(wrap);
  scrollToBottom();
  if (save) saveChatToStorage();
  return wrap;
}

function appendImagePreview(dataUrl, role='user', save=true) {
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'ai');
  const img = document.createElement('img');
  img.src = dataUrl;
  img.style.maxWidth = '280px';
  img.style.display = 'block';
  img.style.borderRadius = '8px';
  bubble.appendChild(img);
  wrap.appendChild(bubble);
  chatEl.appendChild(wrap);
  scrollToBottom();
  if (save) saveChatToStorage();
  return wrap;
}

/* Typing indicator */
function createTyping() {
  const w = document.createElement('div');
  w.className = 'msg ai';
  w.id = 'typingBubble';
  w.innerHTML = `<div class="bubble ai"><div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
  return w;
}
function showTyping() { removeTyping(); chatEl.appendChild(createTyping()); scrollToBottom(); }
function removeTyping() { const t = document.getElementById('typingBubble'); if (t) t.remove(); }

/* ========== TTS ========== */
function speakText(text) {
  if (!('speechSynthesis' in window)) return;
  if (currentUtterance) speechSynthesis.cancel();
  const toSpeak = text.length > 300 ? text.slice(0,300) + '...' : text;
  const ut = new SpeechSynthesisUtterance(toSpeak);
  ut.lang = 'ru-RU';
  ut.onend = () => currentUtterance = null;
  currentUtterance = ut;
  speechSynthesis.speak(ut);
}
stopTTS.onclick = () => { if ('speechSynthesis' in window) speechSynthesis.cancel(); currentUtterance = null; };
ttsToggle.onclick = () => { ttsEnabled = !ttsEnabled; ttsToggle.textContent = ttsEnabled ? '–í–∫–ª—é—á–µ–Ω–æ üîä' : '–û—Ç–∫–ª—é—á–µ–Ω–æ üîà'; };

/* ========== Microphone ========== */
function initRecognitionIfNeeded() {
  if (rec) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return;
  rec = new SR();
  rec.lang = 'ru-RU';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  rec.onresult = (e) => {
    const txt = e.results[0][0].transcript;
    textInput.value = txt;
  };
  rec.onerror = (e) => console.warn('rec error', e);
  rec.onend = () => { if (micActive) rec.start(); };
}
micToggle.onclick = () => {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'); return; }
  initRecognitionIfNeeded();
  micActive = !micActive;
  micToggle.textContent = micActive ? '–í—ã–∫–ª—é—á–∏—Ç—å üé§' : '–í–∫–ª üé§';
  if (micActive) rec.start(); else rec.stop();
};

/* ========== Attach / Preview / Drag & Drop ========== */
attachBtn.onclick = () => fileInput.click();
photoBtn.onclick = () => fileInput.click();
samplePhotoBtn.onclick = () => {
  // Load sample local image path into preview as Data URL (works in environments that allow local file access)
  // We set the preview src to the local path (server/installer will translate /mnt/data/... to URL if needed).
  const local = SAMPLE_LOCAL_PATH;
  // try to fetch it (may fail cross-origin when opened file://); fallback to showing path text bubble
  fetch(local).then(r => r.blob()).then(blob => {
    const reader = new FileReader();
    reader.onload = () => {
      pendingImageDataUrl = reader.result;
      const commaIndex = reader.result.indexOf(',');
      pendingImageBase64 = commaIndex>=0 ? reader.result.slice(commaIndex+1) : reader.result;
      appendMessage('[–¢–µ—Å—Ç–æ–≤–æ–µ —Ñ–æ—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Å —Ç–µ–∫—Å—Ç–æ–º]', 'user');
      appendImagePreview(pendingImageDataUrl, 'user');
    };
    reader.readAsDataURL(blob);
  }).catch(err => {
    // fallback: just show note
    appendMessage('[–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª; –ø—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å]', 'ai');
    console.warn('sample fetch failed', err);
  });
};

fileInput.addEventListener('change', function() {
  const f = this.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    pendingImageDataUrl = reader.result;
    const commaIndex = reader.result.indexOf(',');
    pendingImageBase64 = commaIndex>=0 ? reader.result.slice(commaIndex+1) : reader.result;
    appendMessage('[–§–æ—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ‚Äî –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å]', 'user');
    appendImagePreview(pendingImageDataUrl, 'user');
  };
  reader.readAsDataURL(f);
});

/* Drag & drop */
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) {
    const f = e.dataTransfer.files[0];
    if (f.type.startsWith('image/')) {
      fileInput.files = e.dataTransfer.files;
      fileInput.dispatchEvent(new Event('change'));
    }
  }
});

/* ========== SEND (text + optional image) ========== */
async function sendMessage(textOverride) {
  if (isSending) return;
  const text = (textOverride !== undefined) ? String(textOverride).trim() : textInput.value.trim();
  if (!text && !pendingImageBase64) return;
  if (text) appendMessage(text, 'user', true);
  // If image preview exists, we already appended it as user preview (above).
  textInput.value = '';
  showTyping();
  isSending = true;

  // Build content array as required: role->content[]
  const contentArray = [];
  if (text) contentArray.push({ type: 'input_text', text });
  if (pendingImageBase64) contentArray.push({ type: 'input_image', image_base64: pendingImageBase64 });

  const body = JSON.stringify({
    model: 'gpt-4o-mini',
    input: [
      { role: 'user', content: contentArray }
    ]
  });

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body
    });

    const raw = await res.text();
    removeTyping();

    if (!res.ok) {
      // show server response and body (debug)
      appendMessage(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status} ${res.statusText}`, 'ai', true);
      appendMessage(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${raw}`, 'ai', true);
      console.error('server error', res.status, raw);
    } else {
      let data = {};
      try { data = JSON.parse(raw || '{}'); } catch(e) { console.warn('parse json failed', e); }
      const answer = data.output?.[0]?.content?.[0]?.text || data.choices?.[0]?.message?.content || '–û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç';
      appendMessage(answer, 'ai', true);
      if (ttsEnabled) speakText(answer);
    }
  } catch (err) {
    removeTyping();
    appendMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞', 'ai', true);
    console.error(err);
  } finally {
    // clear pending image after send attempt (success or not)
    pendingImageBase64 = null;
    pendingImageDataUrl = null;
    isSending = false;
  }
}

/* ========== Buttons wiring ========== */
sendBtn.addEventListener('click', () => sendMessage());
textInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
clearBtn.addEventListener('click', () => { chatEl.innerHTML = ''; saveChatToStorage(); });

downloadBtn.addEventListener('click', () => {
  const rows = [...chatEl.querySelectorAll('.msg')].map(m => {
    const who = m.classList.contains('user') ? '–í—ã' : '–ò–ò';
    const txt = m.querySelector('.bubble')?.textContent || '';
    return `${who}: ${txt}`;
  }).join('\n');
  const blob = new Blob([rows], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'dialog.txt'; a.click(); URL.revokeObjectURL(a.href);
});

/* storage buttons */
clearStorageBtn.addEventListener('click', () => {
  if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é?')) clearStorageAndUI();
});
autosaveCheckbox.addEventListener('change', () => { if (autosaveCheckbox.checked) saveChatToStorage(); });

/* menu */
menuToggle.addEventListener('click', () => { slideMenu.classList.toggle('open'); menuToggle.setAttribute('aria-expanded', slideMenu.classList.contains('open')); });
menuClose.addEventListener('click', () => { slideMenu.classList.remove('open'); menuToggle.setAttribute('aria-expanded', 'false'); });

/* load saved chat */
window.addEventListener('load', () => { autosaveCheckbox.checked = true; loadChatFromStorage(); });

/* dblclick AI bubble => speak */
chatEl.addEventListener('dblclick', (e) => {
  const b = e.target.closest('.bubble');
  if (!b) return;
  const parent = b.closest('.msg');
  if (parent && parent.classList.contains('ai')) speakText(b.textContent || '');
});

/* expose debug */
console.log('Using API:', API_URL);
console.log('Sample local path variable (for test button):', SAMPLE_LOCAL_PATH);
</script>
</body>
</html>
